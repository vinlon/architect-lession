# 模块分解

软件的规模和它的复杂度成指数关系，因此通过组件拆分来降低大规模软件的复杂度，但同时拆分后的组件之间的管理也具有一定的复杂度，即架构管理的复杂度


## 组件设计原则 

组件是软件发布和复用的最小粒度单元。

组件的边界与依赖关系，不仅仅是技术问题，还要考虑到业务和团队（人）的因素。

组件vs模块： 组件通常是物理上的概念，模块是逻辑上的概念，一个组件中可能包含多个模块。



- 组件内聚原则 ：组件应该包含哪些功能和类（服务边界的定义）
  - 复用发布等同原则： 软件复用的最小粒度应该**等同于**发布的最小粒度
  - 共同封闭原则 ：我们应该将那些会同时修复，并且为了相同目的而修改的类放到同一个组件中（参考面向对象中的『开放封闭原则』）
  - 共同复用原则：不要强迫一个组件的用户依赖他们不需要的东西（参考面向对象中的『接口隔离原则』）
- 组件耦合原则： 组件之间的耦合关系应该如何设计
  - 无循环依赖原则： 组件的依赖关系中不应该出现环，循环依赖通常出现在组件迭代升级过程中。
  - 稳定依赖原则：不稳定的组件应该依赖稳定（较少变更）的组件 
  - 稳定抽象原则：一个稳定的组件应该是抽象的，而不稳定的组件应该是具体的 （如果你设计的组件是具体的，不稳定的，那么可以为这个组件对外提供的服务抽象一组接口，并把这组接口封装在一个专门的组件中。



# 安全架构

### 常见的攻击

- XSS (跨站脚本攻击）- 用户提交的数据中包含可以在浏览器中执行的脚本，一般是攻击浏览网站的用户，防御的手段是禁止用户提交内容中包含的脚本。
- SQL注入攻击 - 直接攻击数据库
- CSRF(跨站请求伪造) - 利用用户的登录状态，伪造用户请求，防御手段是使用CSRF Token，Token在用户加载页面时获得，提交请求时必须携带该token.



## 信息加密技术及密钥安全管理

### 信息加密技术

- 单项散列加密: 不可逆向
- 对称加密: 加密和解密的密钥相同（适用于加密和解密是同一系统内部完成的场景）
- 非对称加密: 加密和解密的密钥不同（适用于加密和解密是不同系统完成的场景）



## 高可用系统

年度可用性指标  = （1 - 年度不可用时间 / 年度总时间)  * 100%

网站不可用时间 = 故障修复时间点 - 故障发现（报告）时间点


### 故障分

- 故障等级
- 故障权重
- 故障时间


### 引起故障的原因

- 硬件故障
- 软件bug
- 系统发布
- 并发压力
- 网络攻击
- 外部灾害


### 高可用系统架构方案

#### 解耦（在设计和代码层面） -  先写好代码，做好设计

- 高内聚，低耦合的组件设计原则 
- 面向对象基本设计原则 
- 面向对象设计模式
- 领域驱动设计建模


#### 隔离 （物理层面）- 一个系统的故障不会影响另一个系统

- 业务与子系统隔离
- 微服务中台架构
- 生产者消费者隔离
- 虚拟机与容器隔离


#### 异步 - 一个功能的故障不会影响另一个功能

- 多线程编程
- 反应式编程
- 异步网络通信编程
- 事件驱动异步架构


#### 备份

- 集群部署
- 数据库复制（主从，主主）



#### 失效转移（failover) - 前提： 设计无状态的服务

- 数据库主主失效转移
- 负载均衡失效转移



#### 幂等： 服务重复调用，结果和调用一次产生的结果相同。

#### 事务补偿

- 传统事务的ACID
- 分布式事务的BASE（基本可用,弱状态，最终一致性）
- 事务补偿：通过执行业务逻辑逆操作，使事务回滚

#### 重试

#### 熔断： 

当某个服务响应延迟或失败率增加，使用断路器阻断对该服务的调用，使用请求快速失败，避免资源消耗。

#### 限流

在高并场景下，当访问量超过系统处理能力时，使用限流对系统进行保护。 

限流算法：

- 计数器算法 （固定窗口 / 滑动窗口)
- 令牌桶算法: 令牌桶按固定速度放令牌，直到令牌桶放满，请求到达时先向令牌桶请求令牌。
- 漏桶算法： 请求进入时进入漏桶，如容量达到限流值，则将请求放弃，漏桶以固定的算法释放请求。



自适应限流：不是通过人工评估QPS,而是根据运行期的性能指标，实时计算系统的处理能力。



#### 降级

在系统高并发时，关闭非核心功能，将系统资源留给核心的有价值的功能。



#### 异地多活多机房

即使某一个机房不可用，系统仍然可以提供服务。

异地多少的难点是数据同步。





### 高可用系统运维

#### 发布

分批发布保证发布过程中系统一直可用。

#### 自动化测试

系统开发早期使用手工测试成本较低，在系统整体功能趋于稳定，进行更新迭代时，使用自动化测试的成功

#### 自动化部署

#### 持续部署

- 持续集成： 工程师随时向主分支提交代码，并立即进行自动化测试
- 持续交付：自动执行单元测试并发布到各种测试环境中
- 持续部署：在没有人工干预的情况下测试，构建，部署并推送到生产环境。



#### 预发布验证

预发布服务器和正式服务器的唯一区别就是没有配置在负载均衡服务器上，外部用户无法访问。开发工程师通过host域名绑定的方式访问并进行测试。

#### 代码版本控制

- 开发分支：开发工程师从主分支创建一个新的分支进行开发 。
- 测试分支：开发完成后合并到测试分支进行测试
- 发布分支：测试完成后合并到发布分支
- 主分支：发布成功后将代码合并到主分支。



#### 灰度发布

第一次只发布到一批服务器，并使系统运行一段时间，运行正常再发布到所有服务器。

#### 网站运行监控

不允许没有监控的系统上线

- 监控数据采集
- 服务器性能监控
- 业务运行数据报告
- 监控管理： 报警和自动控制



### 高可用价值观

- 保持简单，使问题易于发现，快速解决
- 目标明确，解决特定环境下的具体问题
- 价值回归，成本收益要合理






